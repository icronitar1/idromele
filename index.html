<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Kit - Il Tuo Assistente allo Studio Personale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Libraries for file processing and PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .flashcard-container { perspective: 1000px; }
        .flashcard {
            width: 100%;
            height: 150px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flashcard-front { background-color: white; border: 1px solid #e2e8f0; }
        .flashcard-back { background-color: #f0f9ff; transform: rotateY(180deg); border: 1px solid #bae6fd; }
        .quiz-option { transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .quiz-option.correct { background-color: #dcfce7 !important; border-color: #4ade80 !important; color: #166534; }
        .quiz-option.incorrect { background-color: #fee2e2 !important; border-color: #f87171 !important; color: #991b1b; }
        .quiz-option.disabled { pointer-events: none; opacity: 0.8; }
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        details > summary {
            list-style: none;
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details summary .arrow {
            transition: transform 0.2s;
        }
        details[open] summary .arrow {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600">AI Study Kit</h1>
            <p class="text-slate-600 mt-2 text-lg">Carica un file o incolla un testo per trasformarlo in un kit di studio interattivo!</p>
        </header>

        <!-- Input Section -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
             <label class="block text-lg font-semibold mb-2 text-slate-700">Carica un file (PDF, Word, TXT)</label>
            <div id="file-drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors">
                <!-- ... (SVG and file input identical to previous version) ... -->
                <div class="space-y-1 text-center">
                    <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <div class="flex text-sm text-slate-600">
                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                            <span>Scegli un file</span>
                            <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".pdf,.doc,.docx,.txt">
                        </label>
                        <p class="pl-1">o trascinalo qui</p>
                    </div>
                    <p class="text-xs text-slate-500">PDF, DOCX, TXT</p>
                </div>
            </div>
            <p id="file-status" class="mt-2 text-sm text-slate-600 font-medium"></p>
            
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-300"></div></div>
                <div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-slate-500">OPPURE</span></div>
            </div>

            <label for="inputText" class="block text-lg font-semibold mb-2 text-slate-700">Incolla un testo breve</label>
            <textarea id="inputText" rows="6" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Incolla qui il testo..."></textarea>
            
            <button id="generateBtn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                Crea il Mio Study Kit
            </button>
        </div>
        
        <!-- Loader and Error Message -->
        <div id="loadingContainer" class="text-center my-8 hidden">
             <div id="loader" class="mx-auto"></div>
             <p id="loadingStatus" class="mt-4 text-slate-600 font-medium">L'AI sta preparando il tuo kit di studio...</p>
        </div>
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-4" role="alert">
            <strong class="font-bold">Oops!</strong>
            <span class="block sm:inline">Qualcosa Ã¨ andato storto. Assicurati di aver fornito un testo e riprova.</span>
        </div>

        <!-- Output Section -->
        <div id="outputContainer" class="hidden">
            <!-- Tabs -->
            <div class="mb-6 flex justify-center border-b border-slate-200">
                <button data-tab="summary" class="tab-btn active-tab font-semibold text-blue-600 border-b-2 border-blue-600 px-6 py-3">Riepilogo</button>
                <button data-tab="flashcards" class="tab-btn font-semibold text-slate-500 px-6 py-3">Flashcard</button>
                <button data-tab="quiz" class="tab-btn font-semibold text-slate-500 px-6 py-3">Quiz</button>
            </div>

            <!-- Content Panes -->
            <div id="summary" class="tab-content bg-white p-6 rounded-xl shadow-lg"></div>
            <div id="flashcards" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg"></div>
            <div id="quiz" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg"></div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // DOM Elements
        const generateBtn = document.getElementById('generateBtn');
        const inputText = document.getElementById('inputText');
        const outputContainer = document.getElementById('outputContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingStatus = document.getElementById('loadingStatus');
        const errorMessage = document.getElementById('errorMessage');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileUpload = document.getElementById('file-upload');
        const fileStatus = document.getElementById('file-status');

        let sourceText = ''; // To hold text from files
        let generatedData = []; // Array of objects, each representing a chunk

        // API Configuration
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // --- File Handling ---
        function setupFileHandlers() {
            ['dragover', 'dragleave', 'drop'].forEach(eventName => fileDropZone.addEventListener(eventName, preventDefaults, false));
            fileDropZone.addEventListener('dragover', () => fileDropZone.classList.add('border-blue-500', 'bg-blue-50'));
            fileDropZone.addEventListener('dragleave', () => fileDropZone.classList.remove('border-blue-500', 'bg-blue-50'));
            fileDropZone.addEventListener('drop', e => {
                fileDropZone.classList.remove('border-blue-500', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
            });
            fileUpload.addEventListener('change', e => {
                if (e.target.files.length > 0) handleFile(e.target.files[0]);
            });
        }
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        async function handleFile(file) {
            fileStatus.textContent = `Estrazione testo da: ${file.name}...`;
            inputText.value = '';
            inputText.disabled = true;
            generateBtn.disabled = true;

            try {
                let text = '';
                if (file.type === 'application/pdf') text = await extractTextFromPdf(file);
                else if (file.name.endsWith('.docx')) text = await extractTextFromDocx(file);
                else if (file.type === 'text/plain') text = await file.text();
                else throw new Error('Formato file non supportato.');
                
                sourceText = text;
                fileStatus.textContent = `âï¸ File caricato: ${file.name}. Pronto per la creazione!`;
                if (text) generateBtn.disabled = false;
            } catch (err) {
                console.error('Error handling file:', err);
                sourceText = '';
                fileStatus.textContent = `â Errore nel caricamento: ${err.message}`;
            } finally {
                inputText.disabled = false;
            }
        }

        async function extractTextFromPdf(file) { /* ... identical to previous version ... */ return "extracted text"; }
        async function extractTextFromDocx(file) { /* ... identical to previous version ... */ return "extracted text"; }
        
        inputText.addEventListener('input', () => {
            sourceText = ''; // Clear file source if user types manually
            fileStatus.textContent = '';
            generateBtn.disabled = inputText.value.trim().length === 0;
        });

        // --- Generation Logic ---
        generateBtn.addEventListener('click', async () => {
            const text = sourceText || inputText.value.trim();
            if (!text) return;

            // Reset UI
            outputContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loadingContainer.classList.remove('hidden');
            generatedData = [];

            try {
                const textChunks = chunkText(text, 15000);
                for (let i = 0; i < textChunks.length; i++) {
                    loadingStatus.textContent = `L'AI sta analizzando la sezione ${i + 1} di ${textChunks.length}...`;
                    const chunk = textChunks[i];
                    
                    const [summaryResult, flashcardsResult, quizResult] = await Promise.all([
                        fetchWithRetry(createPayload(chunk, 'summary')),
                        fetchWithRetry(createPayload(chunk, 'flashcards')),
                        fetchWithRetry(createPayload(chunk, 'quiz'))
                    ]);

                    generatedData.push({
                        chunkNumber: i + 1,
                        summary: JSON.parse(summaryResult.candidates[0].content.parts[0].text) || [],
                        flashcards: JSON.parse(flashcardsResult.candidates[0].content.parts[0].text) || [],
                        quiz: JSON.parse(quizResult.candidates[0].content.parts[0].text) || []
                    });
                }
                activateTab('summary');
                outputContainer.classList.remove('hidden');
            } catch (error) {
                console.error('Error generating study kit:', error);
                errorMessage.classList.remove('hidden');
            } finally {
                loadingContainer.classList.add('hidden');
                loadingStatus.textContent = "L'AI sta preparando il tuo kit di studio...";
            }
        });
        
        function chunkText(text, maxSize) { /* ... identical to previous version ... */ return ["chunk1", "chunk2"]; }
        function createPayload(text, type) { /* ... identical to previous version ... */ return {}; }
        async function fetchWithRetry(payload, maxRetries = 3) { /* ... identical to previous version ... */ return {}; }

        // --- Tab and Rendering Logic ---
        tabButtons.forEach(button => button.addEventListener('click', () => activateTab(button.dataset.tab)));

        function activateTab(targetTab) {
            // Gestisce lo stile dei pulsanti dei tab
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === targetTab) {
                    btn.classList.add('active-tab', 'text-blue-600', 'border-blue-600', 'border-b-2');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('active-tab', 'text-blue-600', 'border-blue-600', 'border-b-2');
                    btn.classList.add('text-slate-500');
                }
            });
            
            // Mostra il pannello del contenuto corretto e nasconde gli altri
            tabContents.forEach(content => {
                if (content.id === targetTab) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            // Esegue il rendering del contenuto del tab attivo
            if (targetTab === 'summary') renderSummary();
            if (targetTab === 'flashcards') renderFlashcards();
            if (targetTab === 'quiz') renderQuiz();
        }

        function renderSummary() {
            const container = document.getElementById('summary');
            if (generatedData.length === 0) {
                 container.innerHTML = `<p class="text-slate-500">Nessun riepilogo generato.</p>`; return;
            }
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Riepilogo per Sezioni</h2>
                    <button id="downloadPdfBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        Scarica PDF
                    </button>
                </div>
                <div class="space-y-4" id="summary-content"></div>
            `;
            const content = document.getElementById('summary-content');
            generatedData.forEach(chunk => {
                const details = document.createElement('details');
                details.className = 'bg-slate-50 border border-slate-200 rounded-lg';
                details.innerHTML = `
                    <summary class="p-4 font-semibold text-lg flex justify-between items-center">
                        Sezione ${chunk.chunkNumber}
                        <span class="arrow text-blue-500">&#9654;</span>
                    </summary>
                    <div class="p-4 border-t border-slate-200 space-y-4">
                        ${chunk.summary.map(item => `
                            <div>
                                <h4 class="font-semibold text-slate-700">${item.domanda}</h4>
                                <p class="mt-1 text-slate-600">${item.risposta}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                content.appendChild(details);
            });
            document.getElementById('downloadPdfBtn').addEventListener('click', generateSummaryPdf);
        }

        function generateSummaryPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text('AI Study Kit - Riepilogo Domande', margin, yPos);
            yPos += 15;

            generatedData.forEach(chunk => {
                if (yPos > pageHeight - 30) { doc.addPage(); yPos = margin; }
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.text(`Sezione ${chunk.chunkNumber}`, margin, yPos);
                yPos += 10;
                
                chunk.summary.forEach(item => {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    const questionLines = doc.splitTextToSize(`D: ${item.domanda}`, 180);
                    doc.text(questionLines, margin, yPos);
                    yPos += (questionLines.length * 5);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    const answerLines = doc.splitTextToSize(`R: ${item.risposta}`, 175);
                    doc.text(answerLines, margin + 5, yPos);
                    yPos += (answerLines.length * 5) + 5;
                    
                    if (yPos > pageHeight - 20) { doc.addPage(); yPos = margin; }
                });
            });
            doc.save('riepilogo-studio.pdf');
        }

        function renderFlashcards() {
             const container = document.getElementById('flashcards');
             if (generatedData.length === 0) { container.innerHTML = `<p class="text-slate-500">Nessuna flashcard generata.</p>`; return; }
             container.innerHTML = `<h2 class="text-2xl font-bold mb-6 text-slate-800">Flashcard per Sezioni</h2><div id="flashcards-content" class="space-y-6"></div>`;
             const content = document.getElementById('flashcards-content');
             generatedData.forEach(chunk => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `<h3 class="text-xl font-semibold mb-4">Sezione ${chunk.chunkNumber}</h3>`;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                chunk.flashcards.forEach(cardData => {
                    const card = document.createElement('div');
                    card.className = 'flashcard-container';
                    card.innerHTML = `
                        <div class="flashcard">
                            <div class="flashcard-face flashcard-front"><p class="text-lg font-medium">${cardData.fronte}</p></div>
                            <div class="flashcard-face flashcard-back"><p class="text-md">${cardData.retro}</p></div>
                        </div>`;
                    card.querySelector('.flashcard').addEventListener('click', function() { this.classList.toggle('is-flipped'); });
                    grid.appendChild(card);
                });
                sectionDiv.appendChild(grid);
                content.appendChild(sectionDiv);
             });
        }

        function renderQuiz() {
            const container = document.getElementById('quiz');
            if (generatedData.length === 0) { container.innerHTML = `<p class="text-slate-500">Nessun quiz generato.</p>`; return; }
            container.innerHTML = `<div id="quiz-selection"></div><div id="quiz-runner" class="hidden"></div>`;
            const selectionDiv = document.getElementById('quiz-selection');
            selectionDiv.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-center">Scegli un Quiz</h2><p class="text-center text-slate-500 mb-6">Ogni sezione del documento ha il suo quiz.</p>`;
            const buttonGrid = document.createElement('div');
            buttonGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            generatedData.forEach((chunk, index) => {
                if (chunk.quiz.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'p-4 bg-blue-100 text-blue-800 font-semibold rounded-lg hover:bg-blue-200 transition';
                    button.textContent = `Inizia Quiz - Sezione ${chunk.chunkNumber} (${chunk.quiz.length} domande)`;
                    button.onclick = () => startQuizRunner(index);
                    buttonGrid.appendChild(button);
                }
            });
            selectionDiv.appendChild(buttonGrid);
        }
        
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let score = 0;

        function startQuizRunner(chunkIndex) {
            document.getElementById('quiz-selection').classList.add('hidden');
            document.getElementById('quiz-runner').classList.remove('hidden');
            currentQuizData = generatedData[chunkIndex].quiz;
            currentQuestionIndex = 0;
            score = 0;
            displayQuestion();
        }

        function displayQuestion() {
            const runner = document.getElementById('quiz-runner');
            if (currentQuestionIndex >= currentQuizData.length) {
                displayFinalScore();
                return;
            }
            const q = currentQuizData[currentQuestionIndex];
            const shuffledOptions = [...q.opzioni].sort(() => Math.random() - 0.5);
            runner.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800">Quiz Interattivo</h2>
                    <p class="text-slate-600 font-medium">Domanda ${currentQuestionIndex + 1}/${currentQuizData.length}</p>
                </div>
                <p class="text-lg font-semibold mb-6">${q.domanda}</p>
                <div class="space-y-3">${shuffledOptions.map(opt => `<button class="quiz-option w-full text-left p-4 border rounded-lg hover:bg-slate-100" data-correct="${opt === q.risposta_corretta}">${opt}</button>`).join('')}</div>
                <div id="quiz-feedback" class="mt-6 text-center"></div>`;
            document.querySelectorAll('.quiz-option').forEach(opt => opt.addEventListener('click', checkAnswer));
        }

        function checkAnswer(e) {
            if (e.target.dataset.correct === 'true') score++;
            e.target.classList.add(e.target.dataset.correct === 'true' ? 'correct' : 'incorrect');
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.add('disabled');
                if (opt.dataset.correct === 'true') opt.classList.add('correct');
            });
            const feedback = document.getElementById('quiz-feedback');
            const nextBtn = document.createElement('button');
            nextBtn.textContent = currentQuestionIndex < currentQuizData.length - 1 ? 'Prossima Domanda' : 'Vedi Risultati';
            nextBtn.className = 'mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700';
            nextBtn.onclick = () => { currentQuestionIndex++; displayQuestion(); };
            feedback.appendChild(nextBtn);
        }

        function displayFinalScore() {
            const runner = document.getElementById('quiz-runner');
            const percentage = currentQuizData.length > 0 ? Math.round((score / currentQuizData.length) * 100) : 0;
            runner.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold mb-4">Quiz Completato!</h2>
                    <p class="text-5xl font-bold text-blue-600 mb-6">${score}/${currentQuizData.length} (${percentage}%)</p>
                    <button id="back-to-selection" class="bg-slate-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-800">Torna ai Quiz</button>
                </div>`;
            document.getElementById('back-to-selection').addEventListener('click', () => {
                document.getElementById('quiz-selection').classList.remove('hidden');
                document.getElementById('quiz-runner').classList.add('hidden');
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', setupFileHandlers);

        // --- Dummy functions to make copy-paste of unchanged code smaller ---
        async function extractTextFromPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            return fullText;
        }
        async function extractTextFromDocx(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            return result.value;
        }
        function chunkText(text, maxSize) {
            const chunks = [];
            let remainingText = text;
            while (remainingText.length > 0) {
                if (remainingText.length <= maxSize) { chunks.push(remainingText); break; }
                let chunk = remainingText.substring(0, maxSize);
                let lastBreak = Math.max(chunk.lastIndexOf('.'), chunk.lastIndexOf('\n'), chunk.lastIndexOf(' '));
                let splitIndex = (lastBreak === -1) ? maxSize : lastBreak + 1;
                chunks.push(remainingText.substring(0, splitIndex));
                remainingText = remainingText.substring(splitIndex).trim();
            }
            return chunks.filter(c => c.trim().length > 10);
        }
        function createPayload(text, type) {
            const prompts = {
                summary: `Basandoti su QUESTA PARTE di un testo, genera 3 domande di riepilogo approfondite con risposte concise. Ecco il testo: \n\n${text}`,
                flashcards: `Crea 5 flashcard da QUESTA PARTE di un testo. Ogni flashcard deve avere un "fronte" e un "retro". Ecco il testo: \n\n${text}`,
                quiz: `Genera 3 domande a scelta multipla da QUESTA PARTE di un testo. Per ogni domanda, crea 4 opzioni (di cui una corretta) e indica la risposta. Ecco il testo: \n\n${text}`
            };
            const schemas = {
                summary: { type: "ARRAY", items: { type: "OBJECT", properties: { domanda: { type: "STRING" }, risposta: { type: "STRING" } } } },
                flashcards: { type: "ARRAY", items: { type: "OBJECT", properties: { fronte: { type: "STRING" }, retro: { type: "STRING" } } } },
                quiz: { type: "ARRAY", items: { type: "OBJECT", properties: { domanda: { type: "STRING" }, opzioni: { type: "ARRAY", items: { type: "STRING" } }, risposta_corretta: { type: "STRING" } } } }
            };
            return { contents: [{ parts: [{ text: prompts[type] }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schemas[type] } };
        }
        async function fetchWithRetry(payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }
    </script>
</body>
</html>

